<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lake Champlain - Categorized Water Features</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        .info-box {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 350px;
        }
        .info-box h3 {
            margin: 0 0 10px 0;
            color: #1e88e5;
        }
        .info-box p {
            margin: 5px 0;
            font-size: 13px;
            color: #666;
        }
        .legend {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 12px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #333;
            border-radius: 3px;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 2000;
        }
        .json-display {
            position: absolute;
            top: 60px;
            left: 10px;
            z-index: 1000;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #000;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            pointer-events: none;
        }
        .category-buttons {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        .category-btn {
            flex: 1;
            padding: 5px;
            font-size: 11px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
        }
        .btn-big-lake {
            background: #0d47a1;
        }
        .btn-river {
            background: #4fc3f7;
            color: #333;
        }
        .btn-small-pond {
            background: #b3e5fc;
            color: #333;
        }
        .category-btn.current {
            opacity: 0.5;
            cursor: not-allowed;
            border: 2px solid #333;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">Loading water data...</div>

    <!-- JSON Display -->
    <div id="json-output" class="json-display">[]</div>

    <div class="info-box">
        <h3>ðŸŒŠ Categorized Water</h3>
        <p><strong>First-Order Transform</strong></p>
        <p>Lake Champlain region water separated into 3 datasets</p>
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #0d47a1;"></div>
                <span><strong>Big Lake</strong> (>100 sq km)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #4fc3f7;"></div>
                <span><strong>Rivers/Streams</strong> (elongated)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #b3e5fc;"></div>
                <span><strong>Small Ponds</strong> (<100 sq km)</span>
            </div>
        </div>
        <p style="margin-top: 10px;"><em>Click features to recategorize</em></p>
        <p style="font-size: 11px; color: #999;"><em>Screenshot JSON â†’ send to Claude</em></p>
    </div>
    <div id="map"></div>

    <script>
        // Track changes and layers
        const changes = [];
        const featureLayerMap = new Map(); // Map HYDROID to layer

        // Initialize map
        const map = L.map('map').setView([44.5, -73.25], 9);

        let layersLoaded = 0;
        const totalLayers = 3;

        // Color schemes for categories
        const categoryStyles = {
            'Big Lake': {
                fillColor: '#0d47a1',
                fillOpacity: 0.7,
                color: '#01579b',
                weight: 2
            },
            'River': {
                fillColor: '#4fc3f7',
                fillOpacity: 0.7,
                color: '#0277bd',
                weight: 2
            },
            'Small Pond': {
                fillColor: '#b3e5fc',
                fillOpacity: 0.6,
                color: '#0288d1',
                weight: 1
            }
        };

        // Function to update changes list
        function addChange(hydroid, name, fromCategory, toCategory) {
            // Remove any existing edits for this HYDROID from this session
            const existingIndex = changes.findIndex(c => c.hydroid === hydroid);
            if (existingIndex !== -1) {
                changes.splice(existingIndex, 1);
            }

            const change = {
                hydroid: hydroid,
                name: name,
                from: fromCategory,
                to: toCategory,
                timestamp: new Date().toISOString()
            };
            changes.push(change);
            updateChangesDisplay();
        }

        function updateChangesDisplay() {
            const jsonOutput = document.getElementById('json-output');
            jsonOutput.textContent = JSON.stringify(changes, null, 2);
        }

        function createPopupContent(props, currentCategory) {
            // Normalize category name for comparison
            const normalizedCurrent = currentCategory.replace('River/Stream', 'River').replace('Small Pond/Lake', 'Small Pond');

            const isBigLake = normalizedCurrent === 'Big Lake';
            const isRiver = normalizedCurrent === 'River';
            const isSmallPond = normalizedCurrent === 'Small Pond';

            return `
                <strong>${currentCategory}</strong><br>
                <b>Name:</b> ${props.FULLNAME || 'Unnamed'}<br>
                <b>Area:</b> ${props.area_sqkm.toFixed(4)} sq km<br>
                <b>Elongation:</b> ${props.elongation.toFixed(2)}<br>
                <hr style="margin: 5px 0;">
                <small>
                <b>TIGER Data:</b><br>
                HYDROID: ${props.HYDROID || 'N/A'}<br>
                MTFCC: ${props.MTFCC || 'N/A'}<br>
                AWATER: ${props.AWATER || 'N/A'}<br>
                ANSICODE: ${props.ANSICODE || 'null'}
                </small>
                <div class="category-buttons">
                    <button class="category-btn btn-big-lake ${isBigLake ? 'current' : ''}" onclick="reassignCategory('${props.HYDROID}', '${props.FULLNAME || 'Unnamed'}', '${currentCategory}', 'Big Lake')" ${isBigLake ? 'disabled' : ''}>Big Lake</button>
                    <button class="category-btn btn-river ${isRiver ? 'current' : ''}" onclick="reassignCategory('${props.HYDROID}', '${props.FULLNAME || 'Unnamed'}', '${currentCategory}', 'River')" ${isRiver ? 'disabled' : ''}>River</button>
                    <button class="category-btn btn-small-pond ${isSmallPond ? 'current' : ''}" onclick="reassignCategory('${props.HYDROID}', '${props.FULLNAME || 'Unnamed'}', '${currentCategory}', 'Small Pond')" ${isSmallPond ? 'disabled' : ''}>Pond</button>
                </div>
            `;
        }

        function reassignCategory(hydroid, name, fromCategory, toCategory) {
            if (fromCategory === toCategory) {
                return;
            }

            // Update the change log
            addChange(hydroid, name, fromCategory, toCategory);

            // Visually update the feature on the map
            const layer = featureLayerMap.get(hydroid);
            if (layer) {
                const newStyle = categoryStyles[toCategory];
                layer.setStyle(newStyle);
            }

            map.closePopup();
        }

        function checkLoading() {
            layersLoaded++;
            if (layersLoaded === totalLayers) {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Load Big Lake
        fetch('json/champlain_big_lake.json')
            .then(response => response.json())
            .then(data => {
                console.log('========== BIG LAKE ==========');
                console.log('Metadata:', data.metadata);
                console.log('Features count:', data.features.length);

                // Log all HYDROIDs
                const hydroids = data.features.map(f => f.properties.HYDROID);
                console.log('HYDROIDs:', hydroids);

                // Log Lake Champlain features
                const champlain = data.features.filter(f => f.properties.FULLNAME && f.properties.FULLNAME.includes('Champlain'));
                console.log('Lake Champlain pieces:', champlain.length);
                champlain.forEach(f => {
                    console.log(`  - ${f.properties.FULLNAME}: ${f.properties.area_sqkm.toFixed(2)} sq km, HYDROID: ${f.properties.HYDROID}`);
                });

                L.geoJSON(data, {
                    style: {
                        fillColor: '#0d47a1',
                        fillOpacity: 0.7,
                        color: '#01579b',
                        weight: 2
                    },
                    onEachFeature: (feature, layer) => {
                        const props = feature.properties;
                        featureLayerMap.set(props.HYDROID, layer);
                        layer.bindPopup(createPopupContent(props, 'Big Lake'));
                    }
                }).addTo(map);
                checkLoading();
            })
            .catch(error => {
                console.error('Error loading big lake:', error);
                checkLoading();
            });

        // Load Rivers/Streams
        fetch('json/champlain_rivers.json')
            .then(response => response.json())
            .then(data => {
                console.log('Rivers:', data.metadata);
                L.geoJSON(data, {
                    style: {
                        fillColor: '#4fc3f7',
                        fillOpacity: 0.7,
                        color: '#0277bd',
                        weight: 2
                    },
                    onEachFeature: (feature, layer) => {
                        const props = feature.properties;
                        featureLayerMap.set(props.HYDROID, layer);
                        layer.bindPopup(createPopupContent(props, 'River/Stream'));
                    }
                }).addTo(map);
                checkLoading();
            })
            .catch(error => {
                console.error('Error loading rivers:', error);
                checkLoading();
            });

        // Load Small Ponds (filtered for display)
        fetch('json/champlain_small_ponds.json')
            .then(response => response.json())
            .then(data => {
                console.log('Small Ponds:', data.metadata);

                // Filter to only show ponds larger than 0.01 sq km for performance
                const filtered = {
                    ...data,
                    features: data.features.filter(f => f.properties.area_sqkm > 0.01)
                };

                console.log(`Displaying ${filtered.features.length} of ${data.features.length} ponds`);

                L.geoJSON(filtered, {
                    style: {
                        fillColor: '#b3e5fc',
                        fillOpacity: 0.6,
                        color: '#0288d1',
                        weight: 1
                    },
                    onEachFeature: (feature, layer) => {
                        const props = feature.properties;
                        featureLayerMap.set(props.HYDROID, layer);
                        layer.bindPopup(createPopupContent(props, 'Small Pond/Lake'));
                    }
                }).addTo(map);
                checkLoading();
            })
            .catch(error => {
                console.error('Error loading ponds:', error);
                checkLoading();
            });
    </script>
</body>
</html>
