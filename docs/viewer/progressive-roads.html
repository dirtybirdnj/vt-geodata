<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vermont Roads - Progressive Loader</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; }
        #map { height: 100%; width: 100%; }

        .info-box {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 320px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        .info-box h2 {
            color: #e65100;
            margin-bottom: 8px;
            font-size: 1.2em;
        }
        .info-box p {
            color: #666;
            font-size: 0.9em;
            line-height: 1.4;
            margin-bottom: 10px;
        }
        .status-bar {
            background: #f5f5f5;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        .status-bar .label {
            color: #999;
        }
        .status-bar .value {
            color: #333;
            font-weight: 600;
        }
        .loaded-counties {
            margin-top: 8px;
            font-size: 0.8em;
            color: #666;
        }
        .loaded-counties span {
            display: inline-block;
            background: #e3f2fd;
            color: #1565c0;
            padding: 2px 6px;
            border-radius: 3px;
            margin: 2px;
        }
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
            background: rgba(255,255,255,0.95);
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.3);
            display: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        .loading-indicator.active {
            display: block;
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #e65100;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .back-link {
            position: absolute;
            bottom: 20px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px 15px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            text-decoration: none;
            color: #e65100;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-weight: 600;
            font-size: 0.9em;
        }
        .back-link:hover {
            background: #fff3e0;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div class="info-box">
        <h2>Vermont Road Network</h2>
        <p>60,017 road segments across 14 counties. Pan and zoom to explore - roads load dynamically by county.</p>
        <div class="status-bar">
            <span class="label">Zoom:</span> <span class="value" id="zoom-level">11</span>
        </div>
        <div class="loaded-counties" id="loaded-counties">
            <!-- Dynamically populated -->
        </div>
    </div>

    <div class="loading-indicator" id="loading">
        <span class="spinner"></span>
        <span id="loading-text">Loading roads...</span>
    </div>

    <a href="../index.html" class="back-link">← Back to Index</a>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const MIN_ZOOM = 11;

        // State
        let countyBounds = {};
        let loadedCounties = new Set();
        let countyLayers = {};

        // Road style by type
        const ROAD_COLORS = {
            'S1100': '#d32f2f',  // Interstate
            'S1200': '#ff9800',  // Highway
            'S1400': '#666666',  // Local
            'S1500': '#8d6e63',  // Trail
            'S1630': '#9c27b0',  // Ramp
            'S1640': '#607d8b',  // Service
            'S1730': '#bdbdbd',  // Alley
            'S1740': '#a5d6a7',  // Private
            'S1780': '#90a4ae',  // Parking
            'S1820': '#4caf50'   // Bike
        };

        // Initialize map
        const map = L.map('map', {
            center: [44.0, -72.7],
            zoom: MIN_ZOOM,
            minZoom: MIN_ZOOM,
            zoomControl: true
        });

        // Add base tiles
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap © CARTO'
        }).addTo(map);

        // Load county bounds then start loading visible counties
        fetch('../json/county_bounds.json')
            .then(r => r.json())
            .then(data => {
                countyBounds = data;
                console.log('Loaded county bounds:', Object.keys(data));
                // Initial load of visible counties
                updateVisibleCounties();
            });

        // Check if bounds intersect
        function boundsIntersect(bounds1, bounds2) {
            const [s1, w1, n1, e1] = bounds1;
            const [s2, w2, n2, e2] = bounds2;
            return !(e1 < w2 || e2 < w1 || n1 < s2 || n2 < s1);
        }

        // Get visible counties based on current viewport
        function getVisibleCounties() {
            const bounds = map.getBounds();
            const viewBounds = [
                bounds.getSouth(),
                bounds.getWest(),
                bounds.getNorth(),
                bounds.getEast()
            ];

            const visible = [];
            for (const [key, county] of Object.entries(countyBounds)) {
                if (boundsIntersect(viewBounds, county.bounds)) {
                    visible.push(key);
                }
            }
            return visible;
        }

        // Load county road data
        async function loadCounty(countyKey) {
            if (loadedCounties.has(countyKey)) return;

            const county = countyBounds[countyKey];
            if (!county) return;

            console.log(`Loading ${county.name} County roads...`);
            showLoading(`Loading ${county.name} County...`);

            try {
                const response = await fetch(`../json/${county.file}`);
                const geojson = await response.json();

                const layer = L.geoJSON(geojson, {
                    style: feature => ({
                        color: ROAD_COLORS[feature.properties.MTFCC] || '#666666',
                        weight: feature.properties.MTFCC === 'S1100' ? 3 :
                                feature.properties.MTFCC === 'S1200' ? 2 : 1,
                        opacity: 0.8
                    }),
                    onEachFeature: (feature, layer) => {
                        if (feature.properties.FULLNAME) {
                            layer.bindTooltip(feature.properties.FULLNAME);
                        }
                    }
                });

                countyLayers[countyKey] = layer;
                loadedCounties.add(countyKey);
                layer.addTo(map);

                updateLoadedCountiesDisplay();
                console.log(`Loaded ${county.name}: ${geojson.features?.length || 0} features`);

            } catch (err) {
                console.error(`Error loading ${county.name}:`, err);
            }

            hideLoading();
        }

        // Update visible county layers
        async function updateVisibleCounties() {
            const visible = getVisibleCounties();
            console.log('Visible counties:', visible);

            // Load any new visible counties
            for (const countyKey of visible) {
                if (!loadedCounties.has(countyKey)) {
                    await loadCounty(countyKey);
                }
            }

            // Show/hide layers based on visibility
            for (const [key, layer] of Object.entries(countyLayers)) {
                if (visible.includes(key)) {
                    if (!map.hasLayer(layer)) {
                        layer.addTo(map);
                    }
                } else {
                    if (map.hasLayer(layer)) {
                        map.removeLayer(layer);
                    }
                }
            }
        }

        // UI helpers
        function updateLoadedCountiesDisplay() {
            const container = document.getElementById('loaded-counties');
            if (loadedCounties.size === 0) {
                container.innerHTML = '';
                return;
            }

            const names = Array.from(loadedCounties)
                .map(key => countyBounds[key]?.name || key)
                .sort();

            container.innerHTML = '<strong>Loaded:</strong> ' +
                names.map(n => `<span>${n}</span>`).join('');
        }

        function showLoading(text) {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        // Map event handlers
        map.on('zoomend', () => {
            document.getElementById('zoom-level').textContent = map.getZoom();
        });

        map.on('moveend', () => {
            updateVisibleCounties();
        });

        // Initial UI
        document.getElementById('zoom-level').textContent = map.getZoom();
    </script>
</body>
</html>
